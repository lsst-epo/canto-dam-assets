{"version":3,"file":"canto-field-f3a75c4d.js","sources":["../../../../../buildchain/src/js/canto-field.js"],"sourcesContent":["/**\n * =====================================================================================================================\n * Refactored plugin code\n * =====================================================================================================================\n **/\n\n(function ($) {\n  let tokenInfo = {},\n    env = \"canto.com\",\n    appId = \"52ff8ed9d6874d48a3bef9621bc1af26\",\n    currentCantoTagID,\n    formatDistrict;\n\n  const pluginName = \"CantoDamConnector\",\n    defaults = {\n      env: \"canto.com\",\n    };\n\n  // Plugin constructor\n  function Plugin(element, options) {\n    this.element = element;\n\n    this.options = $.extend({}, defaults, options);\n\n    this._defaults = defaults;\n    this._name = pluginName;\n\n    this.init();\n  }\n\n  Plugin.prototype = {\n\n    init: function () {\n\n      $(() => {\n        /* -- this.options gives us access to the $jsonVars that our FieldType passed down to us */\n        settings(this.options);\n\n        // Beginning of Canto's Universal Connector code:\n        window.onmessage = function (event) {\n          var data = event.data;\n          if (data && data.type == \"getTokenInfo\") {\n            var receiver = document.getElementById('cantoUCFrame').contentWindow;\n            tokenInfo.formatDistrict = formatDistrict;\n            receiver.postMessage(tokenInfo, '*');\n          } else if (data && data.type == \"cantoLogout\") {\n            tokenInfo = {};\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n\n          } else if (data && data.type == \"cantoInsertImage\") {\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n            callback(currentCantoTagID, data.assetList);\n\n          } else if (data && data.type == \"closeModal\") {\n            $(\"#fields-dam-preview-image\").remove();\n            $(\"#fields-rosas-clicker\").html(\"Choose a Different DAM Asset\");\n            if (data.cantoId !== 0) {\n              let cantoAsset = data.cantoAssetData[0];\n              $(\"#fields-dam-asset-preview\").prepend(`<img id=\"fields-dam-preview-image\" style=\"max-height:200px; max-width:200px;\" src=${cantoAsset.directUri}>`);\n            }\n            // @TODO: save the cantoId & cantoAssetData into the hidden field data\n            $(\"#fields-dam-asset-preview\").show();\n            $modal.hide();\n\n          } else if (data) {\n            let verifyCode = data;\n            getTokenByVerifycode(verifyCode);\n\n          }\n\n        };\n      });\n    }\n\n  };\n\n  // A really lightweight plugin wrapper around the constructor,\n  // preventing against multiple instantiations\n  $.fn[pluginName] = function (options) {\n    return this.each(function () {\n      if (!$.data(this, \"plugin_\" + pluginName)) {\n        $.data(this, \"plugin_\" + pluginName,\n          new Plugin(this, options));\n      }\n    });\n  };\n\n  function settings(options) {\n    env = options.env;\n    formatDistrict = options.extensions;\n  }\n\n  function getTokenByVerifycode(verifyCode) {\n    $.ajax({\n      type: \"POST\",\n      url: \"https://oauth.canto.com/oauth/api/oauth2/universal2/token\",\n      dataType: \"json\",\n      data: {\n        \"app_id\": appId,\n        \"grant_type\": \"authorization_code\",\n        \"redirect_uri\": \"http://localhost:8080\",\n        \"code\": verifyCode,\n        \"code_verifier\": \"1649285048042\"\n      },\n      success: function (data) {\n        tokenInfo = data;\n        getTenant(tokenInfo);\n\n      },\n      error: function () {\n        alert(\"Get token errorz\");\n      }\n    });\n  }\n\n  function getTenant(tokenInfo) {\n    $.ajax({\n      type: \"GET\",\n      url: \"https://oauth.\" + env + \":443/oauth/api/oauth2/tenant/\" + tokenInfo.refreshToken,\n      success: function (data) {\n        tokenInfo.tenant = data;\n        console.log(\"in test.js loading UC!\");\n        $(\"#cantoUCFrame\").attr(\"src\", \"/admin/_canto-dam-assets/canto-embed.twig\");\n      },\n      error: function () {\n        alert(\"Get tenant error\");\n      }\n    });\n  }\n})(jQuery, window, document);\n\n/**\n * =====================================================================================================================\n * Event handlers originally from script.js\n * =====================================================================================================================\n **/\n\nif ($(\"#fields-dam-asset-preview\").attr(\"data-thumbnailurl\") == null ||\n  $(\"#fields-dam-asset-preview\").attr(\"data-thumbnailurl\") == \"none\") {\n  $(\"#fields-dam-asset-preview\").hide();\n} else {\n  let url = $(\"#fields-dam-asset-preview\").attr(\"data-thumbnailurl\");\n  $(\"#fields-rosas-clicker\").html(\"Choose a Different DAM Asset\");\n  $(\"#fields-dam-asset-preview\").prepend(`<img id=\"fields-dam-preview-image\" style=\"max-height:200px; max-width:200px;\" src=${url}/>`);\n}\n\n/*--------------------------load iframe content---------------------------------------*/\nfunction loadIframeContent(fieldId, elementId, type, accessToken) {\n//  let timeStamp = new Date().getTime();\n  let tokenInfo = {accessToken: accessToken};\n  let cantoLoginPage = \"https://oauth.canto.com/oauth/api/oauth2/universal2/authorize?response_type=code&app_id=\" + \"52ff8ed9d6874d48a3bef9621bc1af26\" + \"&redirect_uri=http://localhost:8080&state=abcd\" + \"&code_challenge=\" + \"1649285048042\" + \"&code_challenge_method=plain\";\n\n  console.log(\"Inside of script.js about to load UC!\");\n  var cantoContentPage = \"/admin/_canto-dam-assets/canto-embed.twig\";\n  if (tokenInfo.accessToken) {\n    // $(\"#cantoUCFrame\").attr(\"data-test\", val);\n    $(\"#cantoUCFrame\").attr(\"data-element\", elementId);\n    $(\"#cantoUCFrame\").attr(\"data-field\", fieldId);\n    $(\"#cantoUCFrame\").attr(\"data-type\", type);\n    $(\"#cantoUCFrame\").attr(\"data-access\", tokenInfo.accessToken);\n    $(\"#cantoUCFrame\").attr(\"src\", cantoContentPage);\n  } else {\n    $(\"#cantoUCFrame\").attr(\"data-element\", elementId);\n    $(\"#cantoUCFrame\").attr(\"data-field\", fieldId);\n    $(\"#cantoUCFrame\").attr(\"data-type\", type);\n    $(\"#cantoUCFrame\").attr(\"src\", cantoLoginPage);\n  }\n}\n\nlet modalMarkup = $(`\n                <div id=\"rosas-modal\" class=\"modal\"> <!-- modal body -->\n                    <div id=\"modal-test\" class=\"body\" style=\"padding: 0;\"> <!-- modal-content -->\n                        <header class=\"header\" style=\"padding: 48px 48px 24px; margin: -24px -24px 0px;\">\n                            <h2>Canto Assets</h2>\n                        </header>\n                        <iframe id=\"cantoUCFrame\" class=\"canto-uc-subiframe\" src=\"\"></iframe>\n                        <div id=\"modal-status-bar\">Uploading Image...</div>\n                    </div>\n                </div>\n                `);\nlet $modal = new Garnish.Modal(modalMarkup, {'autoShow': false});\n\n$(\"#fields-remove-dam-asset\").click(function (e) {\n  // Hide the preview, and change the button name\n  $(\"#fields-rosas-clicker\").html(\"Add a DAM Asset\");\n  $(\"#fields-dam-asset-preview\").hide();\n  // @TODO: empty out the hidden field data\n});\n\n$(\"#fields-rosas-clicker\").click(function (e) {\n  $modal.show();\n  let fieldId = e.target.dataset.field;\n  let elementId = e.target.dataset.element;\n  let type = e.target.dataset.type;\n  let accessToken = e.target.dataset.access;\n  loadIframeContent(fieldId, elementId, type, accessToken);\n});\n\n/**\n * =====================================================================================================================\n * jQuery plugin and other helper functions originally from test.js\n * =====================================================================================================================\n **/\n\nfunction calcImageSize(num) {\n  var size = Math.round(Number(num) / 1024);\n  return size < 1024 ? size + \"KB\" : Math.round(size / 1024) + \"MB\";\n}\n\n// $(\"#uploadBtn\").change(e => {\n//     console.log(\"uploaded!\");\n//     console.log(e);\n// });\n\nfunction replaceCantoTagByImage(id, assetArray) {\n  var body = $(\"body\");\n  var cantoTag = body.find(\"canto\" + \"#\" + id);\n  var imageHtml = \"\";\n  for (var i = 0; i < assetArray.length; i++) {\n    imageHtml += '<div class=\"canto-block\">';\n    imageHtml += '<img class=\"canto-preview-img\" src=\"' + assetArray[i].previewUri + '\">';\n    imageHtml += '<div class=\"canto-preview-name\">Name: ' + assetArray[i].displayName + '</div>';\n    imageHtml += '<div class=\"canto-preview-size\">Size: ' + calcImageSize(assetArray[i].size) + '</div>';\n    imageHtml += '<a class=\"canto-preview-size\" href=\"' + assetArray[i].directUri + '\">Download</a>';\n    imageHtml += '</div>';\n  }\n  cantoTag.replaceWith(imageHtml);\n}\n"],"names":["$","tokenInfo","env","appId","currentCantoTagID","formatDistrict","pluginName","defaults","Plugin","element","options","settings","event","data","receiver","cantoAsset","$modal","getTokenByVerifycode","verifyCode","getTenant","url","loadIframeContent","fieldId","elementId","type","accessToken","cantoLoginPage","cantoContentPage","modalMarkup"],"mappings":"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"}