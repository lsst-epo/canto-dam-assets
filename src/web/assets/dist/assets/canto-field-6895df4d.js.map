{"version":3,"file":"canto-field-6895df4d.js","sources":["../../../../../buildchain/src/js/canto-field.js"],"sourcesContent":["/**\n * =====================================================================================================================\n * Refactored plugin code\n * =====================================================================================================================\n **/\n\n(function ($) {\n  let tokenInfo = {},\n    env = \"canto.com\",\n    appId = \"52ff8ed9d6874d48a3bef9621bc1af26\",\n    currentCantoTagID,\n    formatDistrict;\n\n  const pluginName = \"CantoDamConnector\",\n    defaults = {\n      env: \"canto.com\",\n    };\n\n  // Plugin constructor\n  function Plugin(element, options) {\n    this.element = element;\n\n    this.options = $.extend({}, defaults, options);\n\n    this._defaults = defaults;\n    this._name = pluginName;\n\n    this.init();\n  }\n\n  Plugin.prototype = {\n\n    init: function () {\n\n      $(() => {\n        // this.options gives us access to the $jsonVars that our FieldType passed down to us\n        settings(this.options);\n\n        // Macro for getting a namespaced field selector\n        const fieldNamespaceIdSelector = (fieldName) => '#' + this.options.prefix + '-' + Craft.namespaceId(fieldName, this.options.id);\n\n        // Display the image preview on init\n        const damAssetPreview = fieldNamespaceIdSelector('damAssetPreview');\n        displayImagePreview();\n\n        /**\n         * Displays the image preview for the chosen Canto asset(s)\n         */\n        function displayImagePreview() {\n          const damAssetPreviewWrapper = fieldNamespaceIdSelector('damAssetPreviewWrapper');\n          $(damAssetPreviewWrapper).remove();\n          if ($(damAssetPreview).attr(\"data-thumbnailurl\") == null ||\n            $(damAssetPreview).attr(\"data-thumbnailurl\") == \"none\") {\n            $(damAssetPreview).hide();\n          } else {\n            const url = $(damAssetPreview).attr(\"data-thumbnailurl\");\n            const albumName = $(damAssetPreview).attr(\"data-albumName\");\n            let name = $(damAssetPreview).attr(\"data-thumbnailName\");\n            const assetCount = $(damAssetPreview).attr(\"data-assetCount\");\n            const className = assetCount == 1 ? \"\" : \"canto-asset-preview-stack\";\n            name = assetCount == 1 ? name : `${assetCount} images`;\n            if (albumName.length) {\n              name += ' / ' + albumName;\n            }\n            $(fieldNamespaceIdSelector('chooseAsset')).html(\"Choose a Different DAM Asset\");\n            $(damAssetPreview).prepend(`\n<div id=\"${damAssetPreviewWrapper.slice(1)}\">\n<img class=\"${className}\" style=\"max-height:200px; max-width:200px;\" src=${url}>\n<span>${name}</span><br />\n</div>\n`);\n          }\n        }\n\n        function getTokenByVerifycode(verifyCode) {\n          $.ajax({\n            type: \"POST\",\n            url: \"https://oauth.canto.com/oauth/api/oauth2/universal2/token\",\n            dataType: \"json\",\n            data: {\n              \"app_id\": appId,\n              \"grant_type\": \"authorization_code\",\n              \"redirect_uri\": \"http://localhost:8080\",\n              \"code\": verifyCode,\n              \"code_verifier\": \"1649285048042\"\n            },\n            success: function (data) {\n              tokenInfo = data;\n              getTenant(tokenInfo);\n\n            },\n            error: function () {\n              alert(\"Get token errorz\");\n            }\n          });\n        }\n\n        // Handle adding or changing an asset\n        $(fieldNamespaceIdSelector('chooseAsset')).click((e) => {\n          $modal.show();\n          let fieldId = e.target.dataset.field;\n          let elementId = e.target.dataset.element;\n          let type = e.target.dataset.type;\n          let accessToken = e.target.dataset.access;\n          loadIframeContent(fieldId, elementId, type, accessToken, this.options.bodyClass);\n        });\n\n        // Handle clicks to remove the asset\n        $(fieldNamespaceIdSelector('removeDamAsset')).click((e) => {\n          // Hide the preview, and change the button name\n          $(fieldNamespaceIdSelector('chooseAsset')).html(\"Add a DAM Asset\");\n          $(damAssetPreview).hide();\n          $(fieldNamespaceIdSelector('cantoId')).val(null);\n          $(fieldNamespaceIdSelector('cantoAlbumId')).val(null);\n          $(fieldNamespaceIdSelector('cantoAssetData')).val([]);\n          $(fieldNamespaceIdSelector('cantoAlbumData')).val([]);\n        });\n\n        // Beginning of Canto's Universal Connector code:\n        window.addEventListener(\"message\", (event) => {\n          const data = event.data;\n          // Onlu listen in if we are the target for this fieldId\n          if ($(cantoUCFrame).attr(\"data-field\") != this.options.fieldId) {\n            return;\n          }\n          if (data && data.type == \"getTokenInfo\") {\n            var receiver = document.getElementById(cantoUCFrame.slice(1)).contentWindow;\n            tokenInfo.formatDistrict = formatDistrict;\n            receiver.postMessage(tokenInfo, '*');\n          } else if (data && data.type == \"cantoLogout\") {\n            tokenInfo = {};\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n\n          } else if (data && data.type == \"cantoInsertImage\") {\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n            callback(currentCantoTagID, data.assetList);\n\n          } else if (data && data.type == \"closeModal\") {\n            let cantoAsset = data.cantoAssetData[0];\n            const assetCount = data.cantoAssetData.length;\n            $(damAssetPreview).attr(\"data-assetCount\", assetCount);\n            $(damAssetPreview).attr(\"data-thumbnailUrl\", cantoAsset.url.directUrlOriginal);\n            $(damAssetPreview).attr(\"data-thumbnailName\", cantoAsset.displayName);\n            $(damAssetPreview).attr(\"data-albumName\", data.cantoAlbumData.name);\n            displayImagePreview();\n            // Save the cantoId & cantoAssetData into the hidden field data\n            $(fieldNamespaceIdSelector('cantoId')).val(data.cantoId);\n            $(fieldNamespaceIdSelector('cantoAlbumId')).val(data.cantoAlbumId);\n            $(fieldNamespaceIdSelector('cantoAssetData')).val(JSON.stringify(data.cantoAssetData));\n            $(fieldNamespaceIdSelector('cantoAlbumData')).val(JSON.stringify(data.cantoAlbumData));\n            $(damAssetPreview).show();\n            $modal.hide();\n\n          } else if (data) {\n            let verifyCode = data;\n            getTokenByVerifycode(verifyCode);\n\n          }\n\n        });\n      });\n    }\n\n  };\n\n  // A really lightweight plugin wrapper around the constructor,\n  // preventing against multiple instantiations\n  $.fn[pluginName] = function (options) {\n    return this.each(function () {\n      if (!$.data(this, \"plugin_\" + pluginName)) {\n        $.data(this, \"plugin_\" + pluginName,\n          new Plugin(this, options));\n      }\n    });\n  };\n\n  function settings(options) {\n    env = options.env;\n    formatDistrict = options.extensions;\n  }\n\n  // The modal for the Canto picker\n  const cantoUCFrame = '#cantoDamAssetsUCFrame';\n  let modalMarkup = $(`\n                <div class=\"modal\"> <!-- modal body -->\n                    <div class=\"body modal-test\" style=\"padding: 0;\"> <!-- modal-content -->\n                        <header class=\"header\" style=\"padding: 48px 48px 24px; margin: -24px -24px 0px;\">\n                            <h2>Canto Assets</h2>\n                        </header>\n                        <iframe id=\"${cantoUCFrame.slice(1)}\" class=\"canto-uc-subiframe\" src=\"\"></iframe>\n                        <div class=\"modal-status-bar\">Uploading Image...</div>\n                    </div>\n                </div>\n                `);\n  let $modal = new Garnish.Modal(modalMarkup, {'autoShow': false});\n\n  /*--------------------------load iframe content---------------------------------------*/\n  function loadIframeContent(fieldId, elementId, type, accessToken, bodyClass) {\n//  let timeStamp = new Date().getTime();\n    let tokenInfo = {accessToken: accessToken};\n    let cantoLoginPage = \"https://oauth.canto.com/oauth/api/oauth2/universal2/authorize?response_type=code&app_id=\" + \"52ff8ed9d6874d48a3bef9621bc1af26\" + \"&redirect_uri=http://localhost:8080&state=abcd\" + \"&code_challenge=\" + \"1649285048042\" + \"&code_challenge_method=plain\";\n\n    var cantoContentPage = \"/admin/_canto-dam-assets/canto-embed.twig\";\n    if (tokenInfo.accessToken) {\n      $(cantoUCFrame).attr(\"data-element\", elementId);\n      $(cantoUCFrame).attr(\"data-field\", fieldId);\n      $(cantoUCFrame).attr(\"data-type\", type);\n      $(cantoUCFrame).attr(\"data-access\", tokenInfo.accessToken);\n      $(cantoUCFrame).attr(\"src\", cantoContentPage);\n    } else {\n      $(cantoUCFrame).attr(\"data-element\", elementId);\n      $(cantoUCFrame).attr(\"data-field\", fieldId);\n      $(cantoUCFrame).attr(\"data-type\", type);\n      $(cantoUCFrame).attr(\"src\", cantoLoginPage);\n    }\n\n    // Apply the feature classes for the iFrame immediately, and also after the iFrame as loaded\n    function applyIFrameClasses() {\n      const $iFrameBody = $(cantoUCFrame).contents().find(\"body\");\n      $iFrameBody.removeClass('can-select-single can-select-multiple can-select-album');\n      $iFrameBody.addClass(bodyClass);\n    }\n\n    $(cantoUCFrame).on(\"load\", applyIFrameClasses);\n    applyIFrameClasses();\n  }\n\n  function getTenant(tokenInfo) {\n    $.ajax({\n      type: \"GET\",\n      url: \"https://oauth.\" + env + \":443/oauth/api/oauth2/tenant/\" + tokenInfo.refreshToken,\n      success: function (data) {\n        tokenInfo.tenant = data;\n        $(cantoUCFrame).attr(\"src\", \"/admin/_canto-dam-assets/canto-embed.twig\");\n      },\n      error: function () {\n        alert(\"Get tenant error\");\n      }\n    });\n  }\n\n})(jQuery, window, document);\n\n// Accept HMR as per: https://vitejs.dev/guide/api-hmr.html\nif (import.meta.hot) {\n  import.meta.hot.accept(() => {\n    console.log(\"HMR\")\n  });\n}\n\n// Re-broadcast the custom `vite-script-loaded` event so that we know that this module has loaded\n// Needed because when <script> tags are appended to the DOM, the `onload` handlers\n// are not executed, which happens in the field Settings page, and in slideouts\n// Do this after the document is ready to ensure proper execution order\n$(document).ready(function () {\n  const e = new CustomEvent('vite-script-loaded', {detail: {path: 'src/js/canto-field.js'}});\n  document.dispatchEvent(e);\n});\n"],"names":["$","tokenInfo","env","appId","currentCantoTagID","formatDistrict","pluginName","defaults","Plugin","element","options","settings","fieldNamespaceIdSelector","fieldName","damAssetPreview","displayImagePreview","damAssetPreviewWrapper","url","albumName","name","assetCount","className","getTokenByVerifycode","verifyCode","data","getTenant","e","$modal","fieldId","elementId","type","accessToken","loadIframeContent","event","cantoUCFrame","receiver","cantoAsset","modalMarkup","bodyClass","cantoLoginPage","cantoContentPage","applyIFrameClasses","$iFrameBody"],"mappings":"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"}