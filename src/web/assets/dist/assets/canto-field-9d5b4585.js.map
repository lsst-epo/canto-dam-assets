{"version":3,"file":"canto-field-9d5b4585.js","sources":["../../../../../buildchain/src/js/canto-field.js"],"sourcesContent":["/**\n * =====================================================================================================================\n * Refactored plugin code\n * =====================================================================================================================\n **/\n\n(function ($) {\n  let tokenInfo = {},\n    env = \"canto.com\",\n    appId = \"52ff8ed9d6874d48a3bef9621bc1af26\",\n    currentCantoTagID,\n    formatDistrict;\n\n  const pluginName = \"CantoDamConnector\",\n    defaults = {\n      env: \"canto.com\",\n    };\n\n  // Plugin constructor\n  function Plugin(element, options) {\n    this.element = element;\n\n    this.options = $.extend({}, defaults, options);\n\n    this._defaults = defaults;\n    this._name = pluginName;\n\n    this.init();\n  }\n\n  Plugin.prototype = {\n\n    init: function () {\n\n      $(() => {\n        // this.options gives us access to the $jsonVars that our FieldType passed down to us\n        settings(this.options);\n\n        // Macro for getting a namespaced field selector\n        const fieldNamespaceIdSelector = (fieldName) => `#fields-` + Craft.namespaceId(fieldName, this.options.id);\n\n        // Display the image preview on init\n        const damAssetPreview = fieldNamespaceIdSelector('damAssetPreview');\n        displayImagePreview();\n\n        /**\n         * Displays the image preview for the chosen Canto asset(s)\n         */\n        function displayImagePreview() {\n          const damAssetPreviewWrapper = fieldNamespaceIdSelector('damAssetPreviewWrapper');\n          $(damAssetPreviewWrapper).remove();\n          if ($(damAssetPreview).attr(\"data-thumbnailurl\") == null ||\n            $(damAssetPreview).attr(\"data-thumbnailurl\") == \"none\") {\n            $(damAssetPreview).hide();\n          } else {\n            const url = $(damAssetPreview).attr(\"data-thumbnailurl\");\n            let name = $(damAssetPreview).attr(\"data-thumbnailName\");\n            const assetCount = $(damAssetPreview).attr(\"data-assetCount\");\n            const className = assetCount == 1 ? \"\" : \"canto-asset-preview-stack\";\n            name = assetCount == 1 ? name : `${assetCount} images`;\n            $(fieldNamespaceIdSelector('chooseAsset')).html(\"Choose a Different DAM Asset\");\n            $(damAssetPreview).prepend(`\n<div id=\"${damAssetPreviewWrapper.slice(1)}\">\n<img class=\"${className}\" style=\"max-height:200px; max-width:200px;\" src=${url}>\n<span>${name}</span><br />\n</div>\n`);\n          }\n        }\n\n        // The modal for the Canto picker\n        const cantoUCFrame = fieldNamespaceIdSelector('cantoUCFrame');\n        let modalMarkup = $(`\n                <div class=\"modal\"> <!-- modal body -->\n                    <div class=\"body modal-test\" style=\"padding: 0;\"> <!-- modal-content -->\n                        <header class=\"header\" style=\"padding: 48px 48px 24px; margin: -24px -24px 0px;\">\n                            <h2>Canto Assets</h2>\n                        </header>\n                        <iframe id=\"${cantoUCFrame.slice(1)}\" class=\"canto-uc-subiframe\" src=\"\"></iframe>\n                        <div class=\"modal-status-bar\">Uploading Image...</div>\n                    </div>\n                </div>\n                `);\n        let $modal = new Garnish.Modal(modalMarkup, {'autoShow': false});\n\n        /*--------------------------load iframe content---------------------------------------*/\n        function loadIframeContent(fieldId, elementId, type, accessToken) {\n//  let timeStamp = new Date().getTime();\n          let tokenInfo = {accessToken: accessToken};\n          let cantoLoginPage = \"https://oauth.canto.com/oauth/api/oauth2/universal2/authorize?response_type=code&app_id=\" + \"52ff8ed9d6874d48a3bef9621bc1af26\" + \"&redirect_uri=http://localhost:8080&state=abcd\" + \"&code_challenge=\" + \"1649285048042\" + \"&code_challenge_method=plain\";\n\n          var cantoContentPage = \"/admin/_canto-dam-assets/canto-embed.twig\";\n          if (tokenInfo.accessToken) {\n            $(cantoUCFrame).attr(\"data-element\", elementId);\n            $(cantoUCFrame).attr(\"data-field\", fieldId);\n            $(cantoUCFrame).attr(\"data-type\", type);\n            $(cantoUCFrame).attr(\"data-access\", tokenInfo.accessToken);\n            $(cantoUCFrame).attr(\"src\", cantoContentPage);\n          } else {\n            $(cantoUCFrame).attr(\"data-element\", elementId);\n            $(cantoUCFrame).attr(\"data-field\", fieldId);\n            $(cantoUCFrame).attr(\"data-type\", type);\n            $(cantoUCFrame).attr(\"src\", cantoLoginPage);\n          }\n        }\n\n        function getTenant(tokenInfo) {\n          $.ajax({\n            type: \"GET\",\n            url: \"https://oauth.\" + env + \":443/oauth/api/oauth2/tenant/\" + tokenInfo.refreshToken,\n            success: function (data) {\n              tokenInfo.tenant = data;\n              $(cantoUCFrame).attr(\"src\", \"/admin/_canto-dam-assets/canto-embed.twig\");\n            },\n            error: function () {\n              alert(\"Get tenant error\");\n            }\n          });\n        }\n\n        function getTokenByVerifycode(verifyCode) {\n          $.ajax({\n            type: \"POST\",\n            url: \"https://oauth.canto.com/oauth/api/oauth2/universal2/token\",\n            dataType: \"json\",\n            data: {\n              \"app_id\": appId,\n              \"grant_type\": \"authorization_code\",\n              \"redirect_uri\": \"http://localhost:8080\",\n              \"code\": verifyCode,\n              \"code_verifier\": \"1649285048042\"\n            },\n            success: function (data) {\n              tokenInfo = data;\n              getTenant(tokenInfo);\n\n            },\n            error: function () {\n              alert(\"Get token errorz\");\n            }\n          });\n        }\n\n        // Handle adding or changing an asset\n        $(fieldNamespaceIdSelector('chooseAsset')).click(function (e) {\n          $modal.show();\n          let fieldId = e.target.dataset.field;\n          let elementId = e.target.dataset.element;\n          let type = e.target.dataset.type;\n          let accessToken = e.target.dataset.access;\n          loadIframeContent(fieldId, elementId, type, accessToken);\n        });\n\n        // Handle clicks to remove the asset\n        $(fieldNamespaceIdSelector('removeDamAsset')).click((e) => {\n          // Hide the preview, and change the button name\n          $(fieldNamespaceIdSelector('chooseAsset')).html(\"Add a DAM Asset\");\n          $(damAssetPreview).hide();\n          $(fieldNamespaceIdSelector('cantoId')).val(null);\n          $(fieldNamespaceIdSelector('cantoAssetData')).val([]);\n        });\n\n        // Beginning of Canto's Universal Connector code:\n        window.onmessage = (event) => {\n          var data = event.data;\n          if (data && data.type == \"getTokenInfo\") {\n            var receiver = document.getElementById(cantoUCFrame.slice(1)).contentWindow;\n            tokenInfo.formatDistrict = formatDistrict;\n            receiver.postMessage(tokenInfo, '*');\n          } else if (data && data.type == \"cantoLogout\") {\n            tokenInfo = {};\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n\n          } else if (data && data.type == \"cantoInsertImage\") {\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n            callback(currentCantoTagID, data.assetList);\n\n          } else if (data && data.type == \"closeModal\") {\n            let cantoAsset = data.cantoAssetData[0];\n            const assetCount = data.cantoAssetData.length;\n            $(damAssetPreview).attr(\"data-assetCount\", assetCount);\n            $(damAssetPreview).attr(\"data-thumbnailUrl\", cantoAsset.directUri);\n            $(damAssetPreview).attr(\"data-thumbnailName\", cantoAsset.name);\n            displayImagePreview();\n            // Save the cantoId & cantoAssetData into the hidden field data\n            $(fieldNamespaceIdSelector('cantoId')).val(data.cantoId);\n            $(fieldNamespaceIdSelector('cantoAssetData')).val(JSON.stringify(data.cantoAssetData));\n            $(damAssetPreview).show();\n            $modal.hide();\n\n          } else if (data) {\n            let verifyCode = data;\n            getTokenByVerifycode(verifyCode);\n\n          }\n\n        };\n      });\n    }\n\n  };\n\n  // A really lightweight plugin wrapper around the constructor,\n  // preventing against multiple instantiations\n  $.fn[pluginName] = function (options) {\n    return this.each(function () {\n      if (!$.data(this, \"plugin_\" + pluginName)) {\n        $.data(this, \"plugin_\" + pluginName,\n          new Plugin(this, options));\n      }\n    });\n  };\n\n  function settings(options) {\n    env = options.env;\n    formatDistrict = options.extensions;\n  }\n\n})(jQuery, window, document);\n\n/**\n * =====================================================================================================================\n * Event handlers originally from script.js\n * =====================================================================================================================\n **/\n\n\n"],"names":["$","tokenInfo","env","appId","currentCantoTagID","formatDistrict","pluginName","defaults","Plugin","element","options","settings","fieldNamespaceIdSelector","fieldName","damAssetPreview","displayImagePreview","damAssetPreviewWrapper","url","name","assetCount","className","cantoUCFrame","modalMarkup","$modal","loadIframeContent","fieldId","elementId","type","accessToken","cantoLoginPage","cantoContentPage","getTenant","data","getTokenByVerifycode","verifyCode","event","receiver","cantoAsset"],"mappings":"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"}