{"version":3,"file":"canto-field-ehMCriUy.js","sources":["../../../../../buildchain/src/js/canto-field.js"],"sourcesContent":["/**\n * =====================================================================================================================\n * Refactored plugin code\n * =====================================================================================================================\n **/\n\n(function ($) {\n  let tokenInfo = {},\n    env,\n    appId,\n    tenantHostName,\n    currentCantoTagID,\n    formatDistrict;\n\n  const pluginName = \"CantoDamConnector\",\n    defaults = {\n      env: \"canto.com\",\n    };\n\n  // Plugin constructor\n  function Plugin(element, options) {\n    this.element = element;\n\n    this.options = $.extend({}, defaults, options);\n\n    this._defaults = defaults;\n    this._name = pluginName;\n\n    this.init();\n  }\n\n  Plugin.prototype = {\n\n    init: function () {\n\n      $(() => {\n        // this.options gives us access to the $jsonVars that our FieldType passed down to us\n        settings(this.options);\n\n        // Macro for getting a namespaced field selector\n        const fieldNamespaceIdSelector = (fieldName) => '#' + this.options.prefix + '-' + Craft.namespaceId(fieldName, this.options.id);\n\n        // Display the image preview on init\n        const damAssetPreview = fieldNamespaceIdSelector('damAssetPreview');\n\n        /**\n         * Displays the image preview for the chosen Canto asset(s)\n         */\n        function displayImagePreview() {\n          const damAssetPreviewWrapper = fieldNamespaceIdSelector('damAssetPreviewWrapper');\n          $(damAssetPreviewWrapper).remove();\n          if ($(damAssetPreview).attr(\"data-thumbnailurl\") == null ||\n            $(damAssetPreview).attr(\"data-thumbnailurl\") == \"none\") {\n            $(damAssetPreview).hide();\n          } else {\n            const url = $(damAssetPreview).attr(\"data-thumbnailurl\");\n            const albumName = $(damAssetPreview).attr(\"data-albumName\");\n            let name = $(damAssetPreview).attr(\"data-thumbnailName\");\n            const assetCount = $(damAssetPreview).attr(\"data-assetCount\");\n            const className = assetCount == 1 ? \"\" : \"canto-asset-preview-stack\";\n            name = assetCount == 1 ? name : `${assetCount} images`;\n            if (albumName.length) {\n              name += ' / ' + albumName;\n            }\n            $(fieldNamespaceIdSelector('chooseAsset')).html(\"Choose a Different DAM Asset\");\n            $(damAssetPreview).prepend(`\n<div id=\"${damAssetPreviewWrapper.slice(1)}\">\n<img class=\"${className}\" style=\"max-height:200px; max-width:200px;\" src=${url}>\n<span>${name}</span><br />\n</div>\n`);\n          }\n        }\n\n        function getTokenByVerifycode(verifyCode) {\n          $.ajax({\n            type: \"POST\",\n            url: \"https://oauth.canto.com/oauth/api/oauth2/universal2/token\",\n            dataType: \"json\",\n            data: {\n              \"app_id\": appId,\n              \"grant_type\": \"authorization_code\",\n              \"redirect_uri\": \"http://localhost:8080\",\n              \"code\": verifyCode,\n              \"code_verifier\": \"1649285048042\"\n            },\n            success: function (data) {\n              tokenInfo = data;\n              getTenant(tokenInfo);\n\n            },\n            error: function () {\n              alert(\"Get token errorz\");\n            }\n          });\n        }\n\n        // Handle adding or changing an asset\n        $(fieldNamespaceIdSelector('chooseAsset')).click((e) => {\n          $modal.show();\n          let fieldId = e.target.dataset.field;\n          let elementId = e.target.dataset.element;\n          let type = e.target.dataset.type;\n          let accessToken = e.target.dataset.access;\n          loadIframeContent(fieldId, elementId, type, accessToken, this.options.bodyClass);\n        });\n\n        // Handle clicks to remove the asset\n        $(fieldNamespaceIdSelector('removeDamAsset')).click((e) => {\n          // Hide the preview, and change the button name\n          $(fieldNamespaceIdSelector('chooseAsset')).html(\"Add a DAM Asset\");\n          $(damAssetPreview).hide();\n          $(fieldNamespaceIdSelector('cantoId')).val(null);\n          $(fieldNamespaceIdSelector('cantoAlbumId')).val(null);\n          $(fieldNamespaceIdSelector('cantoAssetData')).val([]);\n          $(fieldNamespaceIdSelector('cantoAlbumData')).val([]);\n        });\n\n        // Beginning of Canto's Universal Connector code:\n        window.addEventListener(\"message\", (event) => {\n          const data = event.data;\n          // Onlu listen in if we are the target for this fieldId\n          if ($(cantoUCFrame).attr(\"data-field\") != this.options.fieldId) {\n            return;\n          }\n          if (data && data.type == \"getTokenInfo\") {\n            var receiver = document.getElementById(cantoUCFrame.slice(1)).contentWindow;\n            tokenInfo.formatDistrict = formatDistrict;\n            tokenInfo.tenant = tenantHostName;\n            receiver.postMessage(tokenInfo, '*');\n          } else if (data && data.type == \"cantoLogout\") {\n            tokenInfo = {};\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n\n          } else if (data && data.type == \"cantoInsertImage\") {\n            $(\".canto-uc-iframe-close-btn\").trigger(\"click\");\n            callback(currentCantoTagID, data.assetList);\n\n          } else if (data && data.type == \"closeModal\") {\n            let cantoAsset = data.cantoAssetData[0];\n            const assetCount = data.cantoAssetData.length;\n            $(damAssetPreview).attr(\"data-assetCount\", assetCount);\n            $(damAssetPreview).attr(\"data-thumbnailUrl\", cantoAsset.url.directUrlPreview);\n            $(damAssetPreview).attr(\"data-thumbnailName\", cantoAsset.name);\n            $(damAssetPreview).attr(\"data-albumName\", data.cantoAlbumData.name);\n            displayImagePreview();\n            // Save the cantoId & cantoAssetData into the hidden field data\n            $(fieldNamespaceIdSelector('cantoId')).val(data.cantoId);\n            $(fieldNamespaceIdSelector('cantoAlbumId')).val(data.cantoAlbumId);\n            $(fieldNamespaceIdSelector('cantoAssetData')).val(JSON.stringify(data.cantoAssetData));\n            $(fieldNamespaceIdSelector('cantoAlbumData')).val(JSON.stringify(data.cantoAlbumData));\n            $(damAssetPreview).show();\n            $modal.hide();\n\n          } else if (data) {\n            let verifyCode = data;\n            getTokenByVerifycode(verifyCode);\n\n          }\n\n        });\n      });\n    }\n\n  };\n\n  // A really lightweight plugin wrapper around the constructor,\n  // preventing against multiple instantiations\n  $.fn[pluginName] = function (options) {\n    return this.each(function () {\n      if (!$.data(this, \"plugin_\" + pluginName)) {\n        $.data(this, \"plugin_\" + pluginName,\n          new Plugin(this, options));\n      }\n    });\n  };\n\n  function settings(options) {\n    env = options.env;\n    appId = options.appId;\n    tenantHostName = options.tenantHostName;\n    formatDistrict = options.extensions;\n  }\n\n  // The modal for the Canto picker\n  const cantoUCFrame = '#cantoDamAssetsUCFrame';\n  let modalMarkup = $(`\n                <div class=\"modal\"> <!-- modal body -->\n                    <div class=\"body modal-test\" style=\"padding: 0;\"> <!-- modal-content -->\n                        <header class=\"header\" style=\"padding: 48px 48px 24px; margin: -24px -24px 0px;\">\n                            <h2>Canto Assets</h2>\n                        </header>\n                        <iframe id=\"${cantoUCFrame.slice(1)}\" class=\"canto-uc-subiframe\" src=\"\"></iframe>\n                        <div class=\"modal-status-bar\">Uploading Image...</div>\n                    </div>\n                </div>\n                `);\n  let $modal = new Garnish.Modal(modalMarkup, {'autoShow': false});\n\n  /*--------------------------load iframe content---------------------------------------*/\n  function loadIframeContent(fieldId, elementId, type, accessToken, bodyClass) {\n//  let timeStamp = new Date().getTime();\n    let tokenInfo = {\n      accessToken: accessToken,\n      tenant: tenantHostName,\n    };\n    let cantoLoginPage = \"https://oauth.canto.com/oauth/api/oauth2/universal2/authorize?response_type=code&app_id=\" + \"52ff8ed9d6874d48a3bef9621bc1af26\" + \"&redirect_uri=http://localhost:8080&state=abcd\" + \"&code_challenge=\" + \"1649285048042\" + \"&code_challenge_method=plain\";\n\n    var cantoContentPage = \"/admin/_canto-dam-assets/canto-embed.twig\";\n    if (tokenInfo.accessToken) {\n      $(cantoUCFrame).attr(\"data-element\", elementId);\n      $(cantoUCFrame).attr(\"data-field\", fieldId);\n      $(cantoUCFrame).attr(\"data-type\", type);\n      $(cantoUCFrame).attr(\"data-access\", tokenInfo.accessToken);\n      $(cantoUCFrame).attr(\"data-tenant\", tokenInfo.tenant);\n      $(cantoUCFrame).attr(\"src\", cantoContentPage);\n    } else {\n      $(cantoUCFrame).attr(\"data-element\", elementId);\n      $(cantoUCFrame).attr(\"data-field\", fieldId);\n      $(cantoUCFrame).attr(\"data-type\", type);\n      $(cantoUCFrame).attr(\"src\", cantoLoginPage);\n    }\n\n    // Apply the feature classes for the iFrame immediately, and also after the iFrame as loaded\n    function applyIFrameClasses() {\n      const $iFrameBody = $(cantoUCFrame).contents().find(\"body\");\n      $iFrameBody.removeClass('can-select-single can-select-multiple can-select-album');\n      $iFrameBody.addClass(bodyClass);\n    }\n\n    $(cantoUCFrame).on(\"load\", applyIFrameClasses);\n    applyIFrameClasses();\n  }\n\n  function getTenant(tokenInfo) {\n    $.ajax({\n      type: \"GET\",\n      url: \"https://oauth.\" + env + \":443/oauth/api/oauth2/tenant/\" + tokenInfo.refreshToken,\n      success: function (data) {\n        tokenInfo.tenant = data;\n        $(cantoUCFrame).attr(\"src\", \"/admin/_canto-dam-assets/canto-embed.twig\");\n      },\n      error: function () {\n        alert(\"Get tenant error\");\n      }\n    });\n  }\n\n})(jQuery, window, document);\n\n// Accept HMR as per: https://vitejs.dev/guide/api-hmr.html\nif (import.meta.hot) {\n  import.meta.hot.accept(() => {\n    console.log(\"HMR\")\n  });\n}\n\n// Re-broadcast the custom `vite-script-loaded` event so that we know that this module has loaded\n// Needed because when <script> tags are appended to the DOM, the `onload` handlers\n// are not executed, which happens in the field Settings page, and in slideouts\n// Do this after the document is ready to ensure proper execution order\n$(document).ready(function () {\n  const e = new CustomEvent('vite-script-loaded', {detail: {path: 'src/js/canto-field.js'}});\n  document.dispatchEvent(e);\n});\n"],"names":["$","tokenInfo","env","appId","tenantHostName","currentCantoTagID","formatDistrict","pluginName","defaults","Plugin","element","options","settings","fieldNamespaceIdSelector","fieldName","damAssetPreview","displayImagePreview","damAssetPreviewWrapper","url","albumName","name","assetCount","className","getTokenByVerifycode","verifyCode","data","getTenant","e","$modal","fieldId","elementId","type","accessToken","loadIframeContent","event","cantoUCFrame","receiver","cantoAsset","modalMarkup","bodyClass","cantoLoginPage","cantoContentPage","applyIFrameClasses","$iFrameBody"],"mappings":"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"}